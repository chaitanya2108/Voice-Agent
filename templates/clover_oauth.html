{% extends "base.html" %} {% block title %}Clover POS OAuth - Bella Vista
Ristorante{% endblock %} {% block content %}
<div class="row">
  <div class="col-md-8 mx-auto">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0">
          <i class="fas fa-credit-card me-2"></i>Clover POS Integration
        </h4>
        <small class="text-light"
          >Connect your Clover POS system for payments</small
        >
      </div>
      <div class="card-body">
        <div id="oauth-status" class="mb-4">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Status:</strong>
            <span id="status-text">Checking connection...</span>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="fas fa-link me-2"></i>OAuth Setup
                </h5>
                <p class="card-text">
                  Connect your Clover POS system to enable payment processing.
                </p>
                <button
                  id="connect-btn"
                  class="btn btn-success"
                  onclick="connectClover()"
                >
                  <i class="fas fa-plug me-1"></i>Connect to Clover
                </button>
                <button
                  id="disconnect-btn"
                  class="btn btn-outline-danger ms-2"
                  onclick="disconnectClover()"
                  style="display: none"
                >
                  <i class="fas fa-unlink me-1"></i>Disconnect
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="fas fa-sync me-2"></i>Menu Sync
                </h5>
                <p class="card-text">
                  Sync your restaurant menu with Clover POS inventory.
                </p>
                <button
                  id="sync-btn"
                  class="btn btn-primary"
                  onclick="syncMenu()"
                  disabled
                >
                  <i class="fas fa-sync me-1"></i>Sync Menu
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <h6>Configuration Details:</h6>
          <ul class="list-unstyled">
            <li><strong>App ID:</strong> {{ config.CLOVER_APP_ID }}</li>
            <li>
              <strong>Redirect URI:</strong> {{ config.CLOVER_REDIRECT_URI }}
            </li>
            <li><strong>Base URL:</strong> {{ config.CLOVER_BASE_URL }}</li>
          </ul>
        </div>

        <div class="mt-4">
          <h6>Setup Instructions:</h6>
          <ol>
            <li>
              Go to your
              <a href="https://sandbox.dev.clover.com" target="_blank"
                >Clover Developer Dashboard</a
              >
            </li>
            <li>Navigate to your app settings</li>
            <li>
              Set the <strong>Alternate Launch Path</strong> to:
              <code>{{ config.CLOVER_REDIRECT_URI }}</code>
            </li>
            <li>Click "Connect to Clover" button above</li>
            <li>Authorize the app in the Clover interface</li>
            <li>You'll be redirected back with authentication complete</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    checkCloverStatus();
  });

  function checkCloverStatus() {
    fetch("/api/clover/status")
      .then((response) => response.json())
      .then((data) => {
        const statusText = document.getElementById("status-text");
        const connectBtn = document.getElementById("connect-btn");
        const disconnectBtn = document.getElementById("disconnect-btn");
        const syncBtn = document.getElementById("sync-btn");

        if (data.authenticated) {
          statusText.textContent = `Connected to Clover POS (Merchant ID: ${data.merchant_id})`;
          statusText.parentElement.className = "alert alert-success";
          connectBtn.style.display = "none";
          disconnectBtn.style.display = "inline-block";
          syncBtn.disabled = false;
        } else {
          statusText.textContent = "Not connected to Clover POS";
          statusText.parentElement.className = "alert alert-warning";
          connectBtn.style.display = "inline-block";
          disconnectBtn.style.display = "none";
          syncBtn.disabled = true;
        }
      })
      .catch((error) => {
        console.error("Error checking status:", error);
        document.getElementById("status-text").textContent =
          "Error checking connection status";
        document.getElementById("status-text").parentElement.className =
          "alert alert-danger";
      });
  }

  function connectClover() {
    window.location.href = "/oauth/authorize";
  }

  function disconnectClover() {
    // Clear session data
    fetch("/api/clover/disconnect", { method: "POST" })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          checkCloverStatus();
        } else {
          alert("Error disconnecting: " + data.error);
        }
      })
      .catch((error) => {
        console.error("Error disconnecting:", error);
        alert("Error disconnecting from Clover");
      });
  }

  function syncMenu() {
    const syncBtn = document.getElementById("sync-btn");
    syncBtn.disabled = true;
    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';

    fetch("/api/clover/sync-menu", { method: "POST" })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert(
            `Menu synced successfully! Created ${data.created_items} items.`
          );
        } else {
          alert("Error syncing menu: " + data.error);
        }
      })
      .catch((error) => {
        console.error("Error syncing menu:", error);
        alert("Error syncing menu with Clover");
      })
      .finally(() => {
        syncBtn.disabled = false;
        syncBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Sync Menu';
      });
  }
</script>
{% endblock %}
